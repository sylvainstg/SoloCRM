const p=async(e,n,t,s,o)=>{if(!e)throw new Error("No access token");const a=[`To: ${t}`,`Subject: Re: ${s}`,'Content-Type: text/plain; charset="UTF-8"',"MIME-Version: 1.0","",o].join(`\r
`),i=btoa(unescape(encodeURIComponent(a))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),c=await fetch("https://gmail.googleapis.com/gmail/v1/users/me/messages/send",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({raw:i,threadId:n})});if(!c.ok)throw new Error("Failed to send reply");return await c.json()},m=async(e,n,t,s)=>{if(!e)throw new Error("No access token");const r=[`To: ${n}`,`Subject: ${t}`,'Content-Type: text/plain; charset="UTF-8"',"MIME-Version: 1.0","",s].join(`\r
`),a=btoa(unescape(encodeURIComponent(r))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),i=await fetch("https://gmail.googleapis.com/gmail/v1/users/me/messages/send",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({raw:a})});if(!i.ok)throw new Error("Failed to send email");return await i.json()},d=e=>{if(!e)return"";const n=t=>decodeURIComponent(escape(atob(t.replace(/-/g,"+").replace(/_/g,"/"))));if(e.body&&e.body.size>0&&e.body.data)return n(e.body.data);if(e.parts&&e.parts.length>0){let t=e.parts.find(s=>s.mimeType==="text/html");if(t||(t=e.parts.find(s=>s.mimeType==="text/plain")),!t){const s=e.parts.find(o=>o.mimeType.startsWith("multipart/"));if(s)return d(s)}if(t&&t.body&&t.body.data)return n(t.body.data)}return""},l=async(e,n)=>{if(!e)throw new Error("No access token");const t=await fetch(`https://gmail.googleapis.com/gmail/v1/users/me/threads/${n}`,{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw new Error("Failed to fetch thread details");const s=await t.json(),o=s.messages,r=o[o.length-1],a=d(r.payload);return{id:s.id,messages:s.messages,lastMessageBody:a,snippet:r.snippet}};export{l as getThreadDetails,m as sendEmail,p as sendReply};
