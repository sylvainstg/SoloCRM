const v=async(e,r=50,t,s)=>{if(!e)throw new Error("No access token provided");let a="label:INBOX";s&&(a+=` ${s}`);const d=`https://gmail.googleapis.com/gmail/v1/users/me/threads?maxResults=${r}&q=${encodeURIComponent(a)}${t?`&pageToken=${t}`:""}`,n=await fetch(d,{headers:{Authorization:`Bearer ${e}`}});if(!n.ok){const i=await n.json().catch(()=>({}));throw console.error("Gmail API Error Details:",i),new Error(`Gmail API Error: ${n.status} ${n.statusText} - ${JSON.stringify(i)}`)}const c=await n.json();if(!c.threads)return{threads:[],nextPageToken:void 0};const l=5,j=100,g=[];for(let i=0;i<c.threads.length;i+=l){const k=c.threads.slice(i,i+l);(await Promise.all(k.map(async o=>{var f,w;try{const m=await fetch(`https://gmail.googleapis.com/gmail/v1/users/me/threads/${o.id}`,{headers:{Authorization:`Bearer ${e}`}});if(!m.ok)return m.status===429&&console.warn(`Rate limit hit for thread ${o.id}, skipping.`),null;const $=(await m.json()).messages,p=$[$.length-1],y=p.payload.headers,R=((f=y.find(u=>u.name==="Subject"))==null?void 0:f.value)||"(No Subject)",h=((w=y.find(u=>u.name==="From"))==null?void 0:w.value)||"Unknown",b=h.match(/<([^>]+)>/),T=b?b[1]:h,x=h.includes("<")?h.split("<")[0].trim().replace(/^"|"$/g,""):h,B=new Date(parseInt(p.internalDate)).toLocaleDateString();return{id:o.id,subject:R,from:x,email:T,date:B,snippet:p.snippet}}catch(m){return console.error(`Failed to fetch thread ${o.id}`,m),null}}))).forEach(o=>{o&&g.push(o)}),i+l<c.threads.length&&await new Promise(o=>setTimeout(o,j))}return{threads:g,nextPageToken:c.nextPageToken}},A=async(e,r,t,s,a)=>{if(!e)throw new Error("No access token");const n=[`To: ${t}`,`Subject: Re: ${s}`,'Content-Type: text/plain; charset="UTF-8"',"MIME-Version: 1.0","",a].join(`\r
`),c=btoa(unescape(encodeURIComponent(n))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),l=await fetch("https://gmail.googleapis.com/gmail/v1/users/me/messages/send",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({raw:c,threadId:r})});if(!l.ok)throw new Error("Failed to send reply");return await l.json()},E=e=>{if(!e)return"";const r=t=>decodeURIComponent(escape(atob(t.replace(/-/g,"+").replace(/_/g,"/"))));if(e.body&&e.body.size>0&&e.body.data)return r(e.body.data);if(e.parts&&e.parts.length>0){let t=e.parts.find(s=>s.mimeType==="text/html");if(t||(t=e.parts.find(s=>s.mimeType==="text/plain")),!t){const s=e.parts.find(a=>a.mimeType.startsWith("multipart/"));if(s)return E(s)}if(t&&t.body&&t.body.data)return r(t.body.data)}return""},S=async(e,r)=>{if(!e)throw new Error("No access token");const t=await fetch(`https://gmail.googleapis.com/gmail/v1/users/me/threads/${r}`,{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw new Error("Failed to fetch thread details");const s=await t.json(),a=s.messages,d=a[a.length-1],n=E(d.payload);return{id:s.id,messages:s.messages,lastMessageBody:n,snippet:d.snippet}};export{S as getThreadDetails,v as listEmails,A as sendReply};
